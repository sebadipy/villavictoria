<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- CLAVE RESPONSIVE: Viewport meta tag para asegurar la adaptación en móvil -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Acceso - Villa Victoria</title>
    <!-- Icono tomado del movil_user.html -->
    <link rel="icon" href="logo favicon.png" type="image/png">
    
    <!-- Fuente Inter, la misma usada en ambos archivos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Incluimos Tailwind CSS para estilos rápidos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Incluimos Font Awesome 6.5.2 para íconos, igual que en movil_user.html -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Variables de color tomadas DIRECTAMENTE de movil_user.html */
        :root {
            --color-primary: #4A5568;  /* Gris/Slate para texto/header/botón principal */
            --color-accent: #30B5AA;   /* Teal/Menta para acentos (borde, notificaciones, etc) */
            --color-bg-light: #f3f4f6; /* Fondo */
            --color-card-bg: #ffffff;  /* Fondo de tarjeta/modal */
        }
        
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
        }

        body {
            /* Fuente y Fondo */
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-light);
            /* Asegura que el cuerpo ocupe al menos el alto de la pantalla */
            min-height: 100vh;
            /* Flex para centrar el contenido en caso de que sea corto, como la pantalla de login */
            display: flex;
            align-items: center; /* Centrado vertical */
            justify-content: center; /* Centrado horizontal */
            /* Padding base para evitar que el contenido toque los bordes en móvil */
            padding: 1rem; 
        }

        /* Estilos específicos del formulario de login */
        .login-card {
            background-color: var(--color-card-bg);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 100%;
        }

        .login-button {
            background-color: var(--color-primary);
            transition: background-color 0.3s;
        }

        .login-button:hover:not(:disabled) {
            background-color: var(--color-accent);
        }

        .login-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .input-focus:focus {
            border-color: var(--color-accent) !important;
            box-shadow: 0 0 0 3px rgba(48, 181, 170, 0.5); /* Sombra de enfoque con color accent */
        }
        
        .modal-btn-accent {
            background-color: var(--color-accent);
            transition: background-color 0.3s;
        }
        .modal-btn-accent:hover {
            background-color: #27948a; /* Un tono más oscuro para el hover */
        }
        
        /* --- CLASES COPIADAS DE movil_user.html PARA EL ENCABEZADO --- */
        
        .large-logo {
            width: 170px; 
            height: 170px; 
            margin-bottom: 0.75rem; 
            /* Este filtro es CLAVE: hace el logo blanco y le da una sombra */
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(0, 0, 0, 0.3)); 
        }

        .header-title {
            font-weight: 700; 
            letter-spacing: -0.01em; 
        }
        
        /* Las demás clases pasadas no se usan en este archivo (muestras, modal, tags) */

    </style>
</head>
<body>
    
    <!-- Contenedor Principal (Login Card) -->
    <div class="login-card p-8 rounded-lg">
        <!-- SIMULAMOS EL COLOR DEL HEADER DE movil_user.html para el fondo de este bloque de branding -->
        <div class="text-center bg-[var(--color-primary)] p-5 -mx-8 -mt-8 rounded-t-lg text-white shadow-xl">
            
            <!-- LOGO GRANDE Y TÍTULO COMPLETO: Replicando la estructura del header de movil_user.html -->
            <img 
                src="logo.png" 
                alt="Logo Villa Victoria" 
                class="large-logo mx-auto" 
                onerror="this.onerror=null; this.src='https://placehold.co/170x170/30B5AA/ffffff?text=Logo';" 
            />
            
            <div class="text-center">
                <h1 class="header-title text-3xl sm:text-4xl uppercase">
                    VILLA VICTORIA
                </h1>
                <p class="text-gray-300 text-sm font-light mt-1 px-2">
                    Centro Cultural Victoria Ocampo - Villa Victoria - Mar del Plata - Batán - Partido de General Pueyrredon.
                </p>
            </div>
        </div>

        <!-- Contenido del formulario de Acceso -->
        <div class="text-center mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700">Acceso</h2>
            <p class="text-gray-500 mt-2">Ingresá tus credenciales para continuar.</p>
        </div>

        <form id="loginForm" class="space-y-4">
            <!-- Campo de Nombre de Usuario -->
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                <input type="text" id="username" name="username" required
                       class="input-focus w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none"
                       placeholder="Tu nombre de usuario o email" autocomplete="username">
            </div>

            <!-- Campo de Contraseña -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="password" name="password" required
                       class="input-focus w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none"
                       placeholder="Tu contraseña" autocomplete="current-password">
            </div>

            <!-- Mensaje de Error (Inicialmente oculto) -->
            <!-- MANTENEMOS ESTO OCULTO, AHORA USAMOS EL MODAL -->
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm" role="alert">
                <span id="errorText"></span>
            </div>

            <!-- Mensaje de Carga (Inicialmente oculto) -->
            <div id="loadingMessage" class="hidden text-center text-[var(--color-primary)] text-sm">
                <i class="fas fa-spinner fa-spin mr-2"></i> Verificando credenciales...
            </div>
            
            <!-- Botón de Acceso -->
            <button type="submit" 
                    class="login-button w-full text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:shadow-xl transition duration-300 ease-in-out"
                    aria-live="polite">
                <i class="fas fa-sign-in-alt mr-2"></i> Acceder
            </button>
        </form>
    </div>

    <!-- Modal de Bienvenida (ÉXITO) -->
    <div id="welcomeModal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all duration-300">
            <div class="text-center">
                <!-- Icono de Confirmación -->
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                
                <h3 class="mt-4 text-xl leading-6 font-bold text-[var(--color-primary)]">
                    ¡Bienvenido/a!
                </h3>
                
                <div class="mt-2">
                    <p id="welcomeMessage" class="text-sm text-gray-500">
                        Hola, [Nombre Completo]. ¡Acceso exitoso! Estás siendo redirigido al panel principal.
                    </p>
                </div>
            </div>
            
            <div class="mt-5 sm:mt-6">
                <button type="button" id="modalContinueBtn"
                    class="modal-btn-accent inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-accent)] sm:text-sm">
                    Continuar como socio <i class="fas fa-arrow-right ml-2 mt-0.5"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Error (FALLO) -->
    <div id="failureModal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all duration-300">
            <div class="text-center">
                <!-- Icono de Error -->
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-times text-red-600 text-xl"></i>
                </div>
                
                <h3 class="mt-4 text-xl leading-6 font-bold text-red-700">
                    Error de Acceso
                </h3>
                
                <div class="mt-2">
                    <p id="failureMessage" class="text-sm text-gray-500">
                        Mensaje de error.
                    </p>
                </div>
            </div>
            
            <div class="mt-5 sm:mt-6">
                <button type="button" id="modalFailureBtn"
                    class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                    Aceptar
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Variables globales para la configuración de la API del Apps Script
        // Asegurate de reemplazar con tu URL REAL del script desplegado!
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQ14RjL8qChoYZsurvp3ryXkdt_WYfOOj7ZRJCwfsIEjJVOahLQ5SoeaC6MtR216DG6Q/exec"; 
        
        // Elementos del DOM
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('errorMessage'); // Mantener para ocultar
        const errorText = document.getElementById('errorText');     // Mantener para ocultar
        const loadingMessage = document.getElementById('loadingMessage');
        const welcomeModal = document.getElementById('welcomeModal');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const modalContinueBtn = document.getElementById('modalContinueBtn');
        // NUEVOS ELEMENTOS DEL MODAL DE FALLO
        const failureModal = document.getElementById('failureModal');
        const failureMessage = document.getElementById('failureMessage');
        const modalFailureBtn = document.getElementById('modalFailureBtn');

        /**
         * Muestra el modal de bienvenida con el nombre completo del usuario.
         * @param {string} fullName - El nombre completo del usuario.
         */
        function showWelcomeModal(fullName) {
            welcomeMessage.innerHTML = `Hola, <strong class="text-[var(--color-primary)]">${fullName}</strong>. ¡Acceso exitoso! Está siendo redirigido a nuestra programación cultural.`;
            welcomeModal.classList.remove('hidden');
            welcomeModal.classList.add('flex');
            
            // Opcional: Centrar el foco en el botón para accesibilidad
            modalContinueBtn.focus();
        }

        /**
         * Muestra el modal de fallo con el mensaje de error.
         * @param {string} message - El mensaje de error a mostrar.
         */
        function showFailureModal(message) {
            failureMessage.textContent = message;
            failureModal.classList.remove('hidden');
            failureModal.classList.add('flex');
            modalFailureBtn.focus();
        }

        /**
         * Re-habilita el formulario y cierra el modal de error.
         */
        function enableLoginFormAndDismissModal() {
            failureModal.classList.remove('flex');
            failureModal.classList.add('hidden');
            
            // Habilitar formulario para reintento
            usernameInput.disabled = false;
            passwordInput.disabled = false;
            loginForm.querySelector('button').disabled = false;
            
            // Enfocar el campo de usuario para reintento rápido
            usernameInput.focus();
        }


        /**
         * Redirige al usuario al dashboard (simulado).
         */
        function redirectToDashboard() {
            // En un entorno real, esta parte redirigiría la página.
            console.log("¡Redirección al dashboard simulada!");

            // Redirigir al archivo movil_user.html (el dashboard de verdad)
            window.location.href = 'movil_user.html'; 
        }

        /**
         * Maneja el evento de envío del formulario de login.
         * @param {Event} e - El evento de formulario.
         */
        async function handleLogin(e) {
            e.preventDefault();
            
            // Asegurarse de ocultar cualquier mensaje anterior (aunque el modal lo reemplaza)
            errorMessage.classList.add('hidden'); 
            
            loadingMessage.classList.remove('hidden');
            
            // Deshabilitar formulario mientras carga
            usernameInput.disabled = true;
            passwordInput.disabled = true;
            loginForm.querySelector('button').disabled = true;

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            // Usamos un loop de reintento para manejar fallos de conexión (backoff exponencial)
            const MAX_RETRIES = 3;
            let currentRetry = 0;

            const makeRequest = async () => {
                 const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Necesario para llamadas entre dominios
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                return response.json();
            };
            
            try {
                let data;
                while (currentRetry < MAX_RETRIES) {
                    try {
                        data = await makeRequest();
                        break; // Éxito, salir del bucle
                    } catch (error) {
                        currentRetry++;
                        if (currentRetry >= MAX_RETRIES) {
                             throw error; // Lanza el error si es el último reintento
                        }
                        // Espera con backoff exponencial
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                
                // Procesar la respuesta del Apps Script
                const success = data.success;
                const fullName = data.fullName;

                if (success) {
                    // Usuario verificado: Mostrar modal de éxito
                    localStorage.setItem('userLoggedIn', 'true');
                    localStorage.setItem('fullName', fullName);
                    
                    showWelcomeModal(fullName);
                    
                } else {
                    // Credenciales incorrectas: Mostrar modal de fallo
                    showFailureModal('Usuario o Contraseña incorrectos. Por favor, verificá tus datos.');
                }

            } catch (error) {
                console.error('Error durante la verificación:', error);
                // Error de conexión: Mostrar modal de fallo
                showFailureModal(`Error de conexión: ${error.message}. Asegurate de haber desplegado correctamente el Apps Script y de que la URL esté bien configurada.`);
            } finally {
                // Ocultar el mensaje de carga SIEMPRE.
                loadingMessage.classList.add('hidden');

                // Si se mostró el modal de éxito, el formulario queda deshabilitado hasta la redirección.
                // Si se mostró el modal de fallo, el formulario queda deshabilitado hasta que el usuario 
                // presione "Aceptar" en el modal (lo maneja la función enableLoginFormAndDismissModal).
            }
        }

        // Asignar listeners
        loginForm.addEventListener('submit', handleLogin);
        modalContinueBtn.addEventListener('click', redirectToDashboard);
        modalFailureBtn.addEventListener('click', enableLoginFormAndDismissModal); // NUEVO LISTENER DE ERROR

    </script>
</body>
</html>