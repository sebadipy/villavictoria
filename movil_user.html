<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muestras y Programación Villa Victoria</title>
    <link rel="icon" href="logo favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        :root {
            --color-primary: #4A5568; 
            --color-accent: #30B5AA;  
            --color-bg-light: #f3f4f6;
            --color-card-bg: #ffffff;
            --color-success: #10B981; /* Tailwind green-500 */
        }

        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-light);
        }
        
        .app-container {
            max-width: 520px; 
            margin: 0 auto;
            min-height: 100vh; 
            background-color: var(--color-card-bg); 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); 
            display: flex;
            flex-direction: column; 
        }
        
        #menuView, #dataView {
            flex: 1; 
            position: relative;
        }

        .flip-container {
            width: 100%;
            height: 100%; 
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        
        .flip-container.flipped {
            transform: rotateY(180deg);
        }

        .flip-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .menu-button {
             width: 100%; 
             padding: 1.5rem; 
             border-radius: 1rem; 
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); 
             transition: transform 0.3s, box-shadow 0.3s;
             background-color: white;
             text-align: left;
             border: 2px solid transparent;
        }
        
        .menu-button:hover {
            transform: scale(1.02);
        }
        
        .back-face {
             transform: rotateY(180deg);
             align-items: center;
             justify-content: center;
             padding: 1rem;
             color: var(--color-primary);
             font-weight: 700;
             text-align: center;
        }

        /* Estilos de las tarjetas de Muestras/Programacion */
        .muestra-card {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05); 
            border-radius: 0.75rem; 
            overflow: hidden;
            background-color: var(--color-card-bg);
        }
        
        .muestra-card.bg-green-100-card {
            background-color: #d1fae5 !important; 
            border-color: #10b981 !important; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); 
        }
        
        @keyframes blink-green {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            }
            50% { 
                opacity: 0.7; 
                box-shadow: 0 0 25px 8px #059669; 
            }
        }

        .muestra-card.blinking-card {
            animation: blink-green 1.5s ease-in-out infinite;
        }
        
        .tag-badge.highlighted-badge {
            padding: 0.5rem 0.8rem; 
            font-size: 0.9rem; 
            font-weight: 900; 
            letter-spacing: 0.05em;
            border: 2px solid #10b981; 
            border-radius: 0.75rem;
        }

        .muestra-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s ease-in-out, padding 0.6s ease-in-out;
            padding: 0 1.25rem;
            background-color: #fcfcfc; 
        }
        
        .muestra-card.open .muestra-content {
            max-height: 1200px; 
            padding: 1rem 1.25rem 1.5rem; 
        }

        .chevron {
            transition: transform 0.4s ease-out; 
            color: var(--color-primary); 
            font-size: 1rem;
        }
        .muestra-card.open .chevron {
            transform: rotate(180deg);
        }

        .header-title {
            font-weight: 700; 
            letter-spacing: -0.01em; 
        }
        
        .detalle-content {
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }

        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            margin-right: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }

        .table-container, .programacion-table, .programacion-table th, .programacion-table td {
            display: none !important; 
        }
        
        .large-logo {
            width: 170px; 
            height: 170px; 
            margin-bottom: 0.75rem; 
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(0, 0, 0, 0.3)); 
        }
        
        /* Estilos base del modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--color-primary);
            max-width: 400px;
            width: 90%;
            padding: 1.5rem;
            border-radius: 1rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
            color: white; 
            border: 4px solid var(--color-accent); 
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        
        .logo-modal {
            filter: brightness(0) invert(1); 
            width: 150px; 
            height: 150px; 
            border-radius: 50%;
            box-shadow: none; 
        }
        
        /* Estilos específicos para el modal de éxito de pago */
        #paymentSuccessModal .modal-content {
            background-color: var(--color-success); /* Fondo verde para éxito */
            border-color: #ffffff; /* Borde blanco */
        }

        #paymentSuccessModal .modal-content i {
            color: #ffffff; /* Icono blanco */
        }

    </style>
</head>
<body>

    <!-- Modal de Bienvenida (Existente) -->
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal-content text-center">
            <img 
                src="logo.png" 
                alt="Logo Villa Victoria" 
                class="logo-modal mx-auto mb-4" 
            />
            <h3 class="text-2xl font-extrabold text-white mb-2">
                ¡Bienvenido/a a Villa Victoria!
            </h3>
            
            <div id="modalMessage" class="text-gray-200 mb-6 text-sm">
                <p>Descubrí las muestras y la programación cultural que ofrece este espacio único en Mar del Plata. Esta es tu guía rápida y en tiempo real.</p>
            </div>
            
            <button 
                onclick="closeModal('welcomeModal')" 
                class="w-full py-2 px-4 bg-[var(--color-accent)] text-white font-bold rounded-lg shadow-md hover:bg-[#289E93] transition duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:ring-offset-2"
            >
                Aceptar
            </button>
        </div>
    </div>
    
    <!-- INICIO: Nuevo Modal de Éxito de Pago -->
    <div id="paymentSuccessModal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-check-circle text-6xl mx-auto mb-4"></i>
            <h3 class="text-3xl font-extrabold text-white mb-2">
                ¡Pago Informado!
            </h3>
            <p class="text-gray-100 mb-6 text-lg">
                Se envió el comprobante por correo electrónico.
            </p>
            
            <button 
                onclick="closeModal('paymentSuccessModal')" 
                class="w-full py-2 px-4 bg-white text-[var(--color-success)] font-bold rounded-lg shadow-md hover:bg-gray-100 transition duration-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2"
            >
                Entendido
            </button>
        </div>
    </div>
    <!-- FIN: Nuevo Modal de Éxito de Pago -->
    
    <div class="app-container">
        
        <header class="p-5 bg-[var(--color-primary)] text-white shadow-xl flex-shrink-0 relative flex flex-col items-center">
            
            <img 
                src="logo.png" 
                alt="Logo Villa Victoria" 
                class="large-logo" 
            />

            <div class="text-center">
                <!-- Saludo dinámico al usuario logueado -->
                <p id="userGreeting" class="text-gray-400 text-sm font-medium mb-1">
                    Cargando socio...
                </p>
                
                <h1 class="header-title text-3xl sm:text-4xl">
                    VILLA VICTORIA
                </h1>
                <p class="text-gray-300 text-sm font-light mt-1">
                    Centro Cultural Victoria Ocampo - Villa Victoria - Mar del Plata - Batán - Partido de General Pueyrredon.
                </p>
            </div>
            
        </header>

        <div id="menuView" class="p-4 flex-1 flex flex-col items-center space-y-6 bg-[var(--color-bg-light)]">
            
            <p class="text-center text-xl font-bold text-gray-700 mt-4">Seleccione una opción</p>

            <div class="w-full px-4" style="max-width: 384px; height: 120px;"> 
                <div 
                    id="muestraButtonFlip"
                    onclick="animateButton(this, 'gestor_muestra')" 
                    class="flip-container h-full"
                >
                    <div class="flip-face menu-button border-[var(--color-accent)] hover:border-[var(--color-accent)]">
                        <div class="flex items-center">
                            <i class="fas fa-camera-retro text-4xl text-[var(--color-accent)] mr-4"></i>
                            <div>
                                <span class="text-xl font-bold text-gray-900 block">Muestras</span>
                                <span class="text-sm text-gray-500">Listado de muestras.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flip-face back-face bg-white shadow-xl">
                        <p class="text-xl font-bold">Aguarde un instante...</p>
                        <i class="fas fa-spinner fa-spin text-4xl mt-3 text-[var(--color-accent)]"></i>
                    </div>
                </div>
            </div>

            <div class="w-full px-4" style="max-width: 384px; height: 120px;"> 
                <div 
                    id="programacionButtonFlip"
                    onclick="animateButton(this, 'gestor_programacion')" 
                    class="flip-container h-full"
                >
                    <div class="flip-face menu-button border-[var(--color-primary)] hover:border-[var(--color-primary)]">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-check text-4xl text-[var(--color-primary)] mr-4"></i>
                            <div>
                                <span class="text-xl font-bold text-gray-900 block">Programaciones</span>
                                <span class="text-sm text-gray-500">Actividades Programadas.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flip-face back-face bg-white shadow-xl">
                        <p class="text-xl font-bold">Aguarde un instante...</p>
                        <i class="fas fa-spinner fa-spin text-4xl mt-3 text-[var(--color-primary)]"></i>
                    </div>
                </div>
            </div>
            
            <!-- Botón de Registro de Pago (EXISTENTE) -->
            <div class="w-full px-4" style="max-width: 384px; height: 120px;"> 
                <div 
                    id="pagoButtonFlip"
                    onclick="animateButton(this, 'registro_pago')" 
                    class="flip-container h-full"
                >
                    <div class="flip-face menu-button border-amber-500 hover:border-amber-500">
                        <div class="flex items-center">
                            <i class="fas fa-credit-card text-4xl text-amber-500 mr-4"></i>
                            <div>
                                <span class="text-xl font-bold text-gray-900 block">Registro de Pago</span>
                                <span class="text-sm text-gray-500">Informar pagos realizados.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flip-face back-face bg-white shadow-xl">
                        <p class="text-xl font-bold">Aguarde un instante...</p>
                        <i class="fas fa-spinner fa-spin text-4xl mt-3 text-amber-500"></i>
                    </div>
                </div>
            </div>
            <!-- FIN: Botón de Registro de Pago -->
            
            <div class="flex-1"></div> </div>

        <div id="dataView" class="hidden flex-1 relative bg-white overflow-y-auto">
            
            <div class="flex items-center justify-between p-3 border-b border-gray-200 sticky top-0 bg-white z-10 shadow-md flex-shrink-0">
                <button onclick="changeView('menu')" class="text-gray-600 hover:text-[var(--color-primary)] transition duration-150 p-2 rounded-full">
                    <i class="fas fa-arrow-left text-lg"></i>
                    <span class="sr-only">Volver al menú</span>
                </button>
                <h2 id="sectionTitle" class="text-xl font-bold text-gray-800 flex-1 text-center pr-10">
                    SECCIÓN
                </h2>
            </div>

            <div class="p-4">
                <!-- Contenedor genérico para listas de datos o el formulario de pago -->
                <div id="dataList" class="space-y-4 pb-12">
                    <div id="loadingSpinner" class="text-center p-12 bg-gray-100 rounded-lg shadow-inner">
                        <i class="fas fa-spinner fa-spin text-5xl text-[var(--color-accent)]"></i>
                        <p class="mt-4 text-gray-700 font-medium text-lg">Cargando datos...</p>
                    </div>
                </div>

                <div id="noResults" class="hidden text-center p-10 bg-gray-100 rounded-lg shadow-md border border-gray-300 mt-6">
                    <i class="fas fa-search-minus text-4xl text-gray-500"></i>
                    <p class="mt-4 text-gray-700 font-bold">¡Uy! No hay datos activos para mostrar en esta sección.</p>
                </div>
                
                <!-- INICIO: Formulario de Registro de Pago (NUEVA SECCIÓN Y CAMPOS) -->
                <div id="paymentFormContainer" class="hidden bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-bold text-[var(--color-primary)] mb-4 border-b pb-2">Adjuntar Comprobante de Pago</h3>
                    <p class="text-sm text-gray-600 mb-6">Por favor, complete los datos del pago y adjunte una imagen del comprobante. Se registrará en la tabla y se enviará por correo.</p>

                    <form id="paymentForm" onsubmit="event.preventDefault(); handlePaymentSubmission();">
                        
                        <!-- NUEVO: Input Monto Pagado -->
                        <div class="mb-4">
                            <label for="paymentMonto" class="block text-sm font-medium text-gray-700 mb-2">Monto Pagado ($):</label>
                            <input 
                                type="number" 
                                id="paymentMonto" 
                                placeholder="Ej: 15000"
                                required
                                min="1"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500"
                            />
                        </div>
                        
                        <!-- NUEVO: Input Referencia de Transacción -->
                        <div class="mb-4">
                            <label for="paymentReferencia" class="block text-sm font-medium text-gray-700 mb-2">Referencia de Transacción (Ej. CBU o Código):</label>
                            <input 
                                type="text" 
                                id="paymentReferencia" 
                                placeholder="Ej: CBU 12345678"
                                required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500"
                            />
                        </div>
                        
                        <!-- NUEVO: Input Método de Pago -->
                        <div class="mb-6">
                            <label for="paymentMetodo" class="block text-sm font-medium text-gray-700 mb-2">Método de Pago:</label>
                            <input 
                                type="text" 
                                id="paymentMetodo" 
                                placeholder="Ej: Transferencia, MercadoPago, etc."
                                value="Transferencia"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500"
                            />
                        </div>

                        <!-- ARCHIVO COMPROBANTE -->
                        <div class="mb-6">
                            <label for="paymentFile" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Comprobante (Imagen/PDF):</label>
                            <input 
                                type="file" 
                                id="paymentFile" 
                                accept="image/*,application/pdf" 
                                required
                                class="w-full p-3 border border-gray-300 rounded-lg bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[var(--color-accent)] file:text-white hover:file:bg-[#289E93] transition duration-200 cursor-pointer"
                            />
                            <p id="fileError" class="text-xs text-red-600 mt-1 hidden">Por favor, cargue un archivo de imagen o PDF válido.</p>
                        </div>
                        
                        <!-- Input de Comentario Opcional -->
                        <div class="mb-6">
                            <label for="paymentComment" class="block text-sm font-medium text-gray-700 mb-2">Comentario (Opcional):</label>
                            <textarea
                                id="paymentComment"
                                rows="3"
                                placeholder="Ej: Pago de cuota de Octubre."
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                            ></textarea>
                        </div>

                        <button 
                            type="submit" 
                            id="submitPaymentButton"
                            class="w-full py-3 px-4 bg-amber-500 text-white font-bold rounded-lg shadow-md hover:bg-amber-600 transition duration-200 focus:outline-none focus:ring-4 focus:ring-amber-300 disabled:opacity-50"
                        >
                            <i class="fas fa-paper-plane mr-2"></i> Enviar Comprobante y Registrar
                        </button>
                        
                        <div id="submissionLoading" class="hidden text-center mt-4 text-gray-700">
                            <i class="fas fa-spinner fa-spin text-xl text-amber-500 mr-2"></i>
                            Enviando y Registrando... por favor espere.
                        </div>
                        <div id="submissionError" class="hidden text-center mt-4 text-red-600 font-medium">
                            <i class="fas fa-exclamation-triangle mr-2"></i> Error al enviar. Intente nuevamente.
                        </div>
                    </form>
                </div>
                <!-- FIN: Formulario de Registro de Pago -->

            </div>
            
        </div>
        
        <footer class="p-3 text-center text-xs text-gray-500 border-t mt-auto bg-gray-50 flex-shrink-0">
            <p class="text-gray-600 font-medium mb-1">Villa Victoria</p>
            <p class="mt-1">Matheu 1851, Mar del Plata, Argentina</p>
            <p>Email: <a href="mailto:villavictoria100@gmail.com" class="hover:text-[var(--color-primary)] transition">villavictoria100@gmail.com</a></p>
            <p>Web: <a href="http://mardelplata.gob.ar/centroculturalvictoriaocampo" target="_blank" class="hover:text-[var(--color-primary)] transition">mardelplata.gob.ar/centroculturalvictoriaocampo</a></p>
            <p class="mt-2 text-gray-400">&copy; 2025 Villa Victoria.</p>
        </footer>
    </div>

    <script type="module">
        // Importaciones de Firebase (se mantienen solo para inicialización del entorno)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // URL de tu Apps Script
        const APPSSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAs_AnRW3nf_G8gz0FxYeQGAIMC5_uYM48kp4V7Op5NrD7-bj3aqTjdJOULye3hicNog/exec'; 

        const dataList = document.getElementById('dataList');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const noResults = document.getElementById('noResults');
        const sectionTitle = document.getElementById('sectionTitle');
        const menuView = document.getElementById('menuView');
        const dataView = document.getElementById('dataView');
        const welcomeModal = document.getElementById('welcomeModal');
        const paymentSuccessModal = document.getElementById('paymentSuccessModal'); 
        const modalMessage = document.getElementById('modalMessage'); 
        const userGreetingEl = document.getElementById('userGreeting'); 
        const paymentFormContainer = document.getElementById('paymentFormContainer'); 
        const submitPaymentButton = document.getElementById('submitPaymentButton'); 
        const submissionLoading = document.getElementById('submissionLoading'); 
        const submissionError = document.getElementById('submissionError'); 
        
        let allData = []; 
        let currentSheet = null; 
        let auth = null; 

        // Función auxiliar para mostrar un modal
        function showModal(modalElement) {
            modalElement.classList.add('open');
        }

        // Función auxiliar para cerrar un modal (modificada para recibir el ID)
        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.classList.remove('open');
            }
            // Al cerrar el modal de bienvenida, guarda en localStorage que ya se mostró
            if (modalId === 'welcomeModal') {
                localStorage.setItem('welcomeModalShown', 'true');
            }
        }
        
        // Función para limpiar solo los datos de sesión relevantes en localStorage
        function clearSessionData() {
            // Asumo que 'fullName' y 'userEmail' son las claves que guardan la sesión
            localStorage.removeItem('fullName');
            localStorage.removeItem('userEmail');
            // NO limpiamos 'welcomeModalShown' para que no vuelva a aparecer el modal
            console.log("Datos de sesión limpiados al cerrar/navegar.");
        }
        
        // Listener para limpiar al cerrar/navegar
        function clearLocalStorageOnClose() {
            clearSessionData();
        }

        // 1. Añadir el listener para limpiar localStorage al cerrar o navegar
        window.addEventListener('beforeunload', clearLocalStorageOnClose);

        // Función para actualizar el saludo en el header
        function updateHeaderGreeting(userName) {
            if (userGreetingEl) {
                userGreetingEl.textContent = `Socio: ${userName}`;
            }
        }
        
        // Función modificada para mostrar el modal y obtener el nombre del usuario
        async function showWelcomeModal(userName) {
            // Usa localStorage para que el modal se muestre solo la primera vez.
            if (!localStorage.getItem('welcomeModalShown')) {
                let todayEvent = null;
                const todayStr = getTodayDateString();
                try {
                    // Intenta cargar la programación para ver si hay un evento hoy
                    const programacion = await fetchSheetData('gestor_programacion');
                    if (programacion && programacion.length > 0) {
                        todayEvent = programacion.find(item => normalizeDate(item.fecha) === todayStr );
                    }
                } catch (error) {
                    console.error('Error al cargar datos para el modal:', error);
                    // Continúa si falla, mostrando el mensaje por defecto
                }

                // Definir saludo principal usando el nombre pasado
                const greetingText = userName === 'Invitado' ? '¡Bienvenido/a al Centro Cultural!' : `¡Hola, ${userName}!`;
                welcomeModal.querySelector('h3').textContent = greetingText;

                if (todayEvent) {
                    const titulo = todayEvent.titulo || 'Evento Cultural';
                    const rawHora = todayEvent.hora || 'todo el día';
                    const hora = rawHora.replace(/\s*hs/i, '').trim();
                    modalMessage.innerHTML = `
                        <p class="font-bold text-white mb-4">
                            ¡Hoy te comentamos que está programado el evento: <span class="text-[var(--color-accent)]">${titulo}</span> a las <span class="text-[var(--color-accent)]">${hora}</span>!
                        </p>
                        <p class="text-gray-200 text-sm">
                            Descubrí las muestras y la programación completa navegando por las secciones.
                        </p>
                    `;
                } else {
                    modalMessage.innerHTML = `
                        <p>Descubrí las muestras y la programación cultural que ofrece este espacio único en Mar del Plata. Esta es tu guía rápida y en tiempo real.</p>
                        <p class="mt-2 text-gray-300 text-xs">(Por el momento, no hay eventos de programación exclusivos para hoy).</p>
                    `;
                }
                showModal(welcomeModal);
            }
        } 
        
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Obtener nombre del usuario desde localStorage
            const storedName = localStorage.getItem('fullName');
            let userName = storedName; 
            
            // LÓGICA DE REDIRECCIÓN CLAVE: Si no hay nombre, redirigir
            if (!userName || userName === 'Invitado' || userName === '') {
                // Si no hay sesión activa, redirige inmediatamente a la página de login
                console.log("Sesión no encontrada. Redirigiendo a index.html.");
                window.location.href = 'index.html';
                return; // Detiene la ejecución del resto del script
            }

            // 2. Inicializar Firebase (solo por si se necesitan otros servicios)
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                if (firebaseConfig) {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    // Asume que el usuario está logueado, no hace falta sign-in anónimo aquí
                }
            } catch (e) {
                console.error("Fallo durante la inicialización de Firebase:", e);
            }

            // 3. Mostrar saludo en el Header
            updateHeaderGreeting(userName);

            // 4. Continuar con la carga de la vista y el modal de bienvenida
            changeView('menu');
            await showWelcomeModal(userName);
        });

        function normalizeDate(dateValue) {
            if (!dateValue) return null;
            let dateObj;
            if (dateValue instanceof Date) {
                const year = dateValue.getFullYear();
                const month = dateValue.getMonth();
                const day = dateValue.getDate();
                dateObj = new Date(year, month, day, 12);
            } else if (typeof dateValue === 'string') {
                const dateOnly = String(dateValue).split(' ')[0].trim();
                if (dateOnly.includes('/')) {
                    const parts = dateOnly.split('/');
                    if (parts.length === 3) {
                        dateObj = new Date(parts[2], parts[1] - 1, parts[0], 12);
                    }
                } else if (dateOnly.includes('-')) {
                    const cleanDate = dateOnly.replace(/T.*Z$/, '');
                    dateObj = new Date(cleanDate + 'T12:00:00');
                }
            }

            if (dateObj && !isNaN(dateObj.getTime())) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return null;
        }

        function formatDateForDisplay(dateValue) {
            const normalized = normalizeDate(dateValue);
            if (!normalized) return 'Sin Fecha';
            const parts = normalized.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return normalized;
        }

        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function animateButton(flipContainer, sheetName) {
            flipContainer.classList.add('flipped');
            const buttons = document.querySelectorAll('.flip-container');
            buttons.forEach(btn => btn.style.pointerEvents = 'none');

            setTimeout(() => {
                changeView('data', sheetName);
                flipContainer.classList.remove('flipped');
                buttons.forEach(btn => btn.style.pointerEvents = 'auto');
            }, 800);
        }

        function changeView(viewName, sheetName = null) {
            menuView.classList.add('hidden');
            dataView.classList.add('hidden');
            paymentFormContainer.classList.add('hidden'); // Oculta el formulario por defecto
            dataList.classList.remove('hidden'); // Muestra dataList por defecto (para muestras/programación)

            if (viewName === 'menu') {
                menuView.classList.remove('hidden');
                sectionTitle.textContent = 'SECCIÓN';
                dataList.innerHTML = '';
            } else if (viewName === 'data' && sheetName) {
                dataView.classList.remove('hidden');
                currentSheet = sheetName;
                
                // Lógica para mostrar la sección de Pago o la lista de datos
                if (sheetName === 'registro_pago') {
                    sectionTitle.textContent = 'Registro de Pago';
                    // Nos aseguramos de ocultar los contenedores de listas/mensajes de error
                    dataList.classList.add('hidden'); 
                    loadingSpinner.classList.add('hidden'); 
                    noResults.classList.add('hidden'); 
                    paymentFormContainer.classList.remove('hidden'); // Muestra el formulario de pago
                    
                    // Resetear el formulario y los errores al abrir
                    document.getElementById('paymentForm').reset();
                    submissionError.classList.add('hidden');

                } else {
                    // Carga de Muestras o Programación (lógica existente)
                    dataList.classList.remove('hidden');
                    paymentFormContainer.classList.add('hidden'); 
                    
                    if (sheetName === 'gestor_muestra') {
                        sectionTitle.textContent = 'Listado de Muestras';
                        loadAndRenderData('gestor_muestra', renderMuestras);
                    } else if (sheetName === 'gestor_programacion') {
                        sectionTitle.textContent = 'Actividades Programadas';
                        loadAndRenderData('gestor_programacion', renderProgramacion);
                    }
                }
            }
        }
        
        async function fetchSheetData(sheetName) {
            const url = `${APPSSCRIPT_URL}?sheetName=${sheetName}`;
            console.log(`Fetching data from: ${url}`);
            
            // Simular respuesta exitosa si es 'registro_pago' para evitar errores de fetch al usar el mismo flujo de cambio de vista
            if (sheetName === 'registro_pago') {
                 return [];
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Data for ${sheetName}:`, data);
                // La API de Google Sheets puede devolver un objeto con un array 'data'
                return data.data || data; 
            } catch (error) {
                console.error(`Error fetching sheet data for ${sheetName}:`, error);
                return []; 
            }
        }

        async function loadAndRenderData(sheetName, renderFunction) {
            dataList.innerHTML = ''; 
            loadingSpinner.classList.remove('hidden');
            noResults.classList.add('hidden');
            
            const data = await fetchSheetData(sheetName);
            
            loadingSpinner.classList.add('hidden');

            if (data && data.length > 0) {
                renderFunction(data);
                noResults.classList.add('hidden');
            } else {
                noResults.classList.remove('hidden');
            }
        }
        
        function renderMuestras(data) {
            dataList.innerHTML = '';
            
            // Asigna los datos a la variable global para que toggleMuestra pueda usarlos si es necesario
            allData = data; 
            
            data.forEach(muestra => {
                const {
                    titulo = 'Muestra sin título',
                    autor = 'Autor Desconocido',
                    detalle = 'Sin detalle disponible.',
                    costo = 'Consultar',
                    fecha_desde,
                    fecha_hasta,
                    tags = '' 
                } = muestra;
                
                const card = document.createElement('div');
                card.className = 'muestra-card bg-white p-0 shadow-md';
                card.onclick = () => toggleMuestra(card); 
                
                const fechaDisplay = (fecha_desde && fecha_hasta) 
                    ? `${formatDateForDisplay(fecha_desde)} - ${formatDateForDisplay(fecha_hasta)}` 
                    : 'Fechas disponibles';

                const tagBadges = tags.split(',').map(tag => {
                    const trimmedTag = tag.trim();
                    if (!trimmedTag) return '';
                    const colorClass = ['bg-blue-100 text-blue-700', 'bg-purple-100 text-purple-700', 'bg-red-100 text-red-700', 'bg-yellow-100 text-yellow-700'][Math.floor(Math.random() * 4)];
                    return `<span class="tag-badge ${colorClass}">${trimmedTag}</span>`;
                }).join('');

                card.innerHTML = `
                    <div class="p-5 flex justify-between items-center select-none border-b border-gray-100">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium text-gray-500 mb-1">${fechaDisplay}</p>
                            <h3 class="text-lg font-extrabold text-[var(--color-primary)] truncate">${titulo}</h3>
                            <p class="text-sm text-gray-600 font-light truncate">Por: ${autor}</p>
                        </div>
                        <i class="fas fa-chevron-down chevron ml-4 flex-shrink-0"></i>
                    </div>
                    
                    <div class="muestra-content">
                        <div class="space-y-3">
                            ${tagBadges ? `<div class="mb-4">${tagBadges}</div>` : ''}
                            <h3 class="font-bold mb-3 border-b border-gray-200 pb-1 text-md text-[var(--color-primary)]">Detalle:</h3>
                            <p class="text-sm detalle-content">${detalle}</p> 
                            <div class="mt-4 border-t border-gray-100 pt-3">
                                <span class="tag-badge bg-red-100 text-red-700 text-sm">
                                    <i class="fas fa-hand-holding-usd mr-1"></i> Costo: ${costo}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                dataList.appendChild(card);
            });
        }
        
        function renderProgramacion(data) {
            dataList.innerHTML = '';
            
            data.forEach(item => {
                const {
                    titulo = 'Evento sin título',
                    fecha,
                    hora,
                    costo = 'Consultar',
                    detalle = 'Sin detalle disponible.'
                } = item;
                
                const card = document.createElement('div');
                card.className = 'muestra-card bg-white p-0 shadow-md';
                
                const isToday = normalizeDate(fecha) === getTodayDateString();
                
                if (isToday) {
                    card.classList.add('bg-green-100-card', 'blinking-card');
                }

                card.onclick = () => toggleMuestra(card); 
                
                const fechaDisplay = formatDateForDisplay(fecha) || 'Fecha Desconocida';
                const horaDisplay = hora || 'Todo el día';

                card.innerHTML = `
                    <div class="p-5 flex justify-between items-center select-none border-b border-gray-100">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium ${isToday ? 'text-green-700 font-bold' : 'text-gray-500'} mb-1">${isToday ? '¡HOY!' : fechaDisplay}</p>
                            <h3 class="text-lg font-extrabold text-[var(--color-primary)] truncate">${titulo}</h3>
                            <p class="text-sm text-gray-600 font-light truncate"><i class="far fa-clock mr-1"></i> ${horaDisplay}</p>
                        </div>
                        <i class="fas fa-chevron-down chevron ml-4 flex-shrink-0"></i>
                    </div>
                    
                    <div class="muestra-content">
                        <div class="space-y-3">
                            <div class="mb-4">
                                <span class="tag-badge bg-blue-100 text-blue-700 text-sm"><i class="fas fa-calendar-alt mr-1"></i> Fecha: ${fechaDisplay}</span>
                                <span class="tag-badge bg-green-100 text-green-700 text-sm"><i class="fas fa-hand-holding-usd mr-1"></i> Costo: ${costo}</span>
                            </div>
                            <h3 class="font-bold mb-3 border-b border-gray-200 pb-1 text-md text-[var(--color-primary)]">Detalle:</h3>
                            <p class="text-sm detalle-content">${detalle}</p> 
                        </div>
                    </div>
                `;
                dataList.appendChild(card);
            });
        }

        function toggleMuestra(card) {
            const isOpen = card.classList.contains('open');

            // Cierra todas las otras tarjetas abiertas
            document.querySelectorAll('.muestra-card.open').forEach(openCard => {
                if (openCard !== card) {
                    openCard.classList.remove('open');
                }
            });

            // Abre o cierra la tarjeta clickeada
            if (!isOpen) {
                card.classList.add('open');
            } else {
                card.classList.remove('open');
            }
        }
        
        // --- INICIO: LÓGICA DE REGISTRO DE PAGO (ACTUALIZADA CON NUEVOS CAMPOS) ---

        /**
         * Convierte el archivo adjunto a Base64.
         * @param {File} file - El objeto File a convertir.
         * @returns {Promise<string>} Promesa que resuelve con la cadena Base64.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Solo la data Base64
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * Maneja la subida del formulario de pago.
         */
        async function handlePaymentSubmission() {
            const fileInput = document.getElementById('paymentFile');
            const commentInput = document.getElementById('paymentComment');
            const montoInput = document.getElementById('paymentMonto'); // NUEVO
            const referenciaInput = document.getElementById('paymentReferencia'); // NUEVO
            const metodoInput = document.getElementById('paymentMetodo'); // NUEVO
            
            const file = fileInput.files[0];
            const userName = localStorage.getItem('fullName');
            const userEmail = localStorage.getItem('userEmail'); // Asumo que el email también está en localStorage
            
            // 1. Validaciones básicas de campos
            if (!file) {
                document.getElementById('fileError').classList.remove('hidden');
                return;
            } else {
                document.getElementById('fileError').classList.add('hidden');
            }
            
            if (!userName || !userEmail) {
                console.error("Error: No se pudo obtener el nombre o email del socio.");
                submissionError.textContent = 'Error de sesión. Intente recargar la aplicación.';
                submissionError.classList.remove('hidden');
                return;
            }
            
            if (!montoInput.value.trim() || !referenciaInput.value.trim()) {
                submissionError.textContent = 'Por favor, complete el Monto Pagado y la Referencia de Transacción.';
                submissionError.classList.remove('hidden');
                return;
            }


            submitPaymentButton.disabled = true;
            submissionLoading.classList.remove('hidden');
            submissionError.classList.add('hidden');

            try {
                // 2. Convertir archivo a Base64
                const base64Data = await fileToBase64(file);
                
                // 3. Preparar el payload para Apps Script (incluyendo los nuevos campos)
                const payload = {
                    action: 'informar_pago', // Acción para el Apps Script
                    userName: userName,
                    userEmail: userEmail,
                    comment: commentInput.value.trim(),
                    fileData: base64Data,
                    fileName: file.name,
                    mimeType: file.type,
                    recipientEmail: 'sebadipy@hotmail.com',
                    
                    // CAMPOS NUEVOS PARA LA TABLA 'registro_pagos'
                    monto: montoInput.value.trim(),
                    metodoPago: metodoInput.value.trim() || 'Transferencia Bancaria',
                    referenciaTransaccion: referenciaInput.value.trim()
                };
                
                // 4. Enviar a Apps Script
                const response = await fetch(APPSSCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(payload)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // 5. Mostrar modal de éxito
                    showModal(paymentSuccessModal);
                    
                    // 6. Limpiar el formulario
                    document.getElementById('paymentForm').reset();
                    submissionError.classList.add('hidden'); // Asegura que el error esté oculto si hubo éxito
                } else {
                    console.error('Error del servidor:', result.message || 'Error desconocido.');
                    submissionError.textContent = result.message || 'Error al enviar el comprobante. Intente más tarde.';
                    submissionError.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error al procesar o enviar el pago:', error);
                submissionError.textContent = 'Fallo en la conexión o procesamiento del archivo. Asegúrese de que el archivo no sea muy grande.';
                submissionError.classList.remove('hidden');
            } finally {
                submitPaymentButton.disabled = false;
                submissionLoading.classList.add('hidden');
            }
        }

        // --- FIN: LÓGICA DE REGISTRO DE PAGO ---
        
        // Hacemos las funciones necesarias accesibles globalmente 
        // para los manejadores de eventos 'onclick' en el HTML.
        window.closeModal = closeModal;
        window.changeView = changeView;
        window.animateButton = animateButton;
        window.toggleMuestra = toggleMuestra;
        window.handlePaymentSubmission = handlePaymentSubmission; // Exporta la nueva función
        
    </script>
</body>
</html>